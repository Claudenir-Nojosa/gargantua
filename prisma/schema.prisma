generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// MODELOS DO NEXT AUTH (OBRIGATÃ“RIOS)
model User {
  id                   String    @id @default(cuid())
  name                 String
  email                String    @unique
  emailVerified        DateTime?
  password             String?
  image                String?
  telefone             String?   @unique
  subscriptionStatus   String    @default("free")
  stripeSubscriptionId String?
  stripeCustomerId     String?
  createdAt            DateTime  @default(now())
  updatedAt            DateTime  @updatedAt

  // NextAuth relationships
  accounts Account[]
  sessions Session[]

  // Seus relacionamentos existentes (atualizados)
  empresas            Empresa[]
  pendencias          Pendencia[]
  baseLegais          BaseLegal[]
  anotacoes           Anotacao[]
  diagnosticos        Diagnostico[]
  baseLegalFavoritos  BaseLegalFavorito[]
  analisesTributarias AnaliseTributaria[]
  mapeamentosTelefone MapeamentoTelefone[]
  pontos              Pontos[]

  metaPontos       MetaPontos[]
  categorias       Categoria[]
  cartoes          Cartao[]
  lancamentos      Lancamento[]
  pagamentosFatura PagamentoFatura[]

  lancamentosCompartilhadosCriados   LancamentoCompartilhado[] @relation("LancamentosCompartilhadosCriados")
  lancamentosCompartilhadosRecebidos LancamentoCompartilhado[] @relation("LancamentosCompartilhadosRecebidos")

  Lancamento Lancamento[] @relation("LancamentosCompartilhadosCriados")

  MetaPessoal MetaPessoal[]

  LimiteCategoria LimiteCategoria[]

  ColaboradorCartao ColaboradorCartao[]

  ConviteCartao ConviteCartao[]

  ConviteMeta ConviteMeta[]

  ColaboradorMeta ColaboradorMeta[]

  ContribuicaoMeta ContribuicaoMeta[]

  obrigacaos Obrigacao[]

  controleHoras ControleHoras[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String? @db.Text
  access_token      String? @db.Text
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String? @db.Text
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// SEUS MODELOS EXISTENTES (ATUALIZADOS)
model Empresa {
  id                 String          @id @default(cuid())
  codigo             String          @unique
  descricao          String
  cnpj               String          @unique
  uf                 String
  grupo              String
  periodoCadastro    DateTime
  situacao           SituacaoEmpresa
  tributacao         Tributacao
  ie                 String?
  im                 String?
  certificadoDigital Boolean         @default(false)
  email              String?

  // ðŸ†• CAMPOS DE COMPLEXIDADE
  nivelEstudoTecnico     Int?   @db.SmallInt
  demandaDuvidas         Int?   @db.SmallInt
  tempoOperacional       Int?   @db.SmallInt
  organizacaoCliente     Int?   @db.SmallInt
  volumeDocumentos       Int?   @db.SmallInt
  diversidadeOperacoes   Int?   @db.SmallInt
  percentualComplexidade Float?

  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
  userId             String
  user               User                @relation(fields: [userId], references: [id])
  repasse            RepasseEmpresa?
  entregas           Entrega[]
  analiseTributarias AnaliseTributaria[]

  @@map("empresas")
  atividades Atividade[]
}

enum SituacaoEmpresa {
  ATIVA
  NAO_VIGENTE
}

enum Tributacao {
  SIMPLES_NACIONAL
  LUCRO_PRESUMIDO
  LUCRO_REAL
}

model RepasseEmpresa {
  id          String   @id @default(cuid())
  empresaId   String   @unique
  colaborador String
  dataRepasse DateTime
  observacoes String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("repasse_empresas")
}

model ControleHoras {
  id          String   @id @default(cuid())
  data        DateTime // Data do registro
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  
  // HorÃ¡rios previstos
  entradaPrevista     String  // formato: "08:00"
  almocoSaidaPrevista String  // formato: "12:00" 
  almocoRetornoPrevisto String // formato: "13:00"
  saidaPrevista       String  // formato: "17:00"
  
  // HorÃ¡rios reais
  entradaReal         String? // formato: "08:15"
  almocoSaidaReal     String? // formato: "12:05"
  almocoRetornoReal   String? // formato: "13:10"
  saidaReal           String? // formato: "17:30"
  
  // CÃ¡lculos automÃ¡ticos
  atrasoEntrada       Int?    // minutos de atraso na entrada
  atrasoAlmoco        Int?    // minutos de atraso no retorno do almoÃ§o
  horasExtras         Int?    // minutos de horas extras
  horasTrabalhadas    Int?    // minutos trabalhados no dia
  
  observacoes         String?
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@unique([userId, data])
  @@map("controle_horas")
}

model Obrigacao {
  id        String    @id @default(cuid())
  nome      String
  descricao String?
  categoria String
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  userId    String
  user      User      @relation(fields: [userId], references: [id])
  entregas  Entrega[]

  @@unique([nome, userId])
  @@map("obrigacoes")
  atividades Atividade[]
}

model Entrega {
  id            String    @id @default(cuid())
  empresaId     String
  obrigacaoId   String
  mesReferencia String // Formato: "YYYY-MM"
  entregue      Boolean   @default(false)
  dataEntrega   DateTime?
  observacoes   String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  empresa   Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  obrigacao Obrigacao @relation(fields: [obrigacaoId], references: [id], onDelete: Cascade)

  @@unique([empresaId, obrigacaoId, mesReferencia])
  @@map("entregas")
}

// Adicione este modelo ao seu schema.prisma se nÃ£o existir
model AnaliseTributaria {
  id            String   @id @default(cuid())
  empresaId     String
  userId        String
  mesReferencia String
  dadosApuracao Json
  razaoSocial   String
  analiseTexto  String   @db.Text
  indicadores   Json
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  empresa Empresa @relation(fields: [empresaId], references: [id])
  user    User    @relation(fields: [userId], references: [id])

  @@unique([empresaId, mesReferencia])
}

model Atividade {
  id             String   @id @default(cuid())
  nome           String
  horario        String?
  responsavel    String
  responsavelId  String
  responsavelImg String?
  data           DateTime
  concluida      Boolean  @default(false)
  categoria      String   @default("apuracao")
  ordem          Int?     @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // ðŸ†• NOVOS CAMPOS PARA CONTROLE DE TEMPO
  tempoEstimado  Int? // Tempo estimado em minutos
  tempoReal      Int? // Tempo real gasto em minutos
  dataInicio     DateTime? // Quando a atividade foi iniciada
  dataConclusao  DateTime? // Quando a atividade foi concluÃ­da
  emAndamento    Boolean   @default(false) // Se estÃ¡ sendo trabalhada no momento
  historicoTempo Json? // Array de sessÃµes de trabalho {inicio, fim, duracao}

  // ðŸ†• NOVOS CAMPOS PARA VINCULAR ENTREGA
  empresaId     String?   // Vincular a empresa
  obrigacaoId   String?   // Vincular a obrigaÃ§Ã£o
  mesReferencia String?   // MÃªs de referÃªncia da entrega

  // ðŸ†• RELACIONAMENTOS OPCIONAIS
  empresa   Empresa?   @relation(fields: [empresaId], references: [id])
  obrigacao Obrigacao? @relation(fields: [obrigacaoId], references: [id])
}

model Pendencia {
  id           String   @id @default(cuid())
  titulo       String
  descricao    String?
  concluida    Boolean  @default(false)
  criadoEm     DateTime @default(now())
  atualizadoEm DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id])
  userId       String
}

model BaseLegal {
  id             String   @id @default(cuid())
  titulo         String
  descricao      String?
  link           String?
  uf             String
  categoria      String?
  dataPublicacao DateTime
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  userId         String
  user           User     @relation(fields: [userId], references: [id])
  tipoTributo    String?
  tags           String[]
  anotacoes      String?
  status         String?

  Anotacao         Anotacao[]
  ArquivoBaseLegal ArquivoBaseLegal[]
  favoritos        BaseLegalFavorito[]
}

model BaseLegalFavorito {
  id          String   @id @default(cuid())
  baseLegalId String
  userId      String
  createdAt   DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id])
  baseLegal BaseLegal @relation(fields: [baseLegalId], references: [id])

  @@unique([baseLegalId, userId])
}

model ArquivoBaseLegal {
  id          String    @id @default(cuid())
  nome        String
  url         String
  tamanho     Int
  baseLegalId String
  baseLegal   BaseLegal @relation(fields: [baseLegalId], references: [id])
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model Anotacao {
  id          String   @id @default(cuid())
  conteudo    String   @db.Text
  baseLegalId String
  userId      String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user      User      @relation(fields: [userId], references: [id])
  baseLegal BaseLegal @relation(fields: [baseLegalId], references: [id])

  @@unique([baseLegalId, userId])
}

model Diagnostico {
  id          String   @id @default(cuid())
  data        DateTime @default(now())
  cnpj        String
  nomeEmpresa String
  status      String
  formData    Json
  user        User     @relation(fields: [userId], references: [id])
  userId      String
}

model MapeamentoTelefone {
  id        String   @id @default(cuid())
  telefone  String   @unique
  userId    String
  nome      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@map("mapeamento_telefone")
}

model Pontos {
  id           String   @id @default(cuid())
  programa     String
  quantidade   Int
  descricao    String
  data         DateTime
  tipo         String
  valorResgate Float?
  userId       String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // ðŸ†• Campos para CPM
  valorGasto        Float?
  custoPorMilheiro  Float?
  tipoTransferencia String? // "COMPRA", "TRANSFERENCIA", "BONUS"
  bonusPercentual   Float?
  pontosOriginais   Int?
  pontosBonus       Int?

  // ðŸ†• NOVO: Campos para transferÃªncia entre programas
  programaOrigem           String? // Programa de origem da transferÃªncia
  programaDestino          String? // Programa de destino da transferÃªncia
  pontosTransferidos       Int? // Quantidade transferida (antes do bÃ´nus)
  custoPorMilheiroOriginal Float? // CPM antes da transferÃªncia

  user User @relation(fields: [userId], references: [id])

  @@map("pontos")
}

model MetaPontos {
  id         String   @id @default(cuid())
  programa   String
  metaPontos Int
  descricao  String?
  dataAlvo   DateTime
  userId     String
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([programa, userId])
}

model Categoria {
  id        String   @id @default(cuid())
  nome      String
  tipo      String
  cor       String?  @default("#3B82F6")
  icone     String? // ðŸ†• novo campo
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  lancamentos     Lancamento[]
  LimiteCategoria LimiteCategoria[]

  @@unique([nome, userId, tipo])
}

model Cartao {
  id            String   @id @default(cuid())
  nome          String
  bandeira      String
  limite        Float?
  diaFechamento Int?
  diaVencimento Int?
  cor           String   @default("#3B82F6")
  observacoes   String?
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  lancamentos Lancamento[]
  Fatura      Fatura[]

  ColaboradorCartao ColaboradorCartao[]

  ConviteCartao ConviteCartao[]
}

// Modelo para convites de colaboraÃ§Ã£o
model ConviteCartao {
  id             String        @id @default(cuid())
  cartaoId       String
  emailConvidado String
  token          String        @unique
  status         StatusConvite @default(PENDENTE)
  expiraEm       DateTime
  criadoEm       DateTime      @default(now())
  atualizadoEm   DateTime      @updatedAt

  cartao           Cartao @relation(fields: [cartaoId], references: [id], onDelete: Cascade)
  usuarioCriador   User   @relation(fields: [usuarioCriadorId], references: [id])
  usuarioCriadorId String

  @@unique([cartaoId, emailConvidado])
  @@index([token])
}

// Modelo para colaboradores do cartÃ£o
model ColaboradorCartao {
  id        String               @id @default(cuid())
  cartaoId  String
  userId    String
  criadoEm  DateTime             @default(now())
  permissao PermissaoColaborador @default(LEITURA)

  cartao Cartao @relation(fields: [cartaoId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@unique([cartaoId, userId])
}

enum StatusConvite {
  PENDENTE
  ACEITO
  RECUSADO
  EXPIRADO
  CANCELADO
}

enum PermissaoColaborador {
  LEITURA
  ESCRITA
  ADMIN
}

model Lancamento {
  id              String    @id @default(cuid())
  descricao       String
  valor           Float
  tipo            String
  metodoPagamento String
  data            DateTime  @default(now())
  pago            Boolean   @default(true)
  observacoes     String?
  userId          String
  user            User      @relation(fields: [userId], references: [id])
  categoriaId     String
  categoria       Categoria @relation(fields: [categoriaId], references: [id])
  cartaoId        String?
  cartao          Cartao?   @relation(fields: [cartaoId], references: [id])
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  tipoParcelamento   String?
  parcelasTotal      Int?
  parcelaAtual       Int?
  recorrente         Boolean   @default(false)
  dataFimRecorrencia DateTime?

  lancamentoPaiId   String?
  lancamentoPai     Lancamento?  @relation("LancamentoParcelas", fields: [lancamentoPaiId], references: [id])
  lancamentosFilhos Lancamento[] @relation("LancamentoParcelas")
  Fatura            Fatura?      @relation(fields: [faturaId], references: [id])
  faturaId          String?

  // ADICIONE ESTES CAMPOS PARA COMPARTILHAMENTO
  usuarioCriadorId String?
  usuarioCriador   User?   @relation("LancamentosCompartilhadosCriados", fields: [usuarioCriadorId], references: [id])

  LancamentoCompartilhado LancamentoCompartilhado[]
}

model Fatura {
  id              String            @id @default(cuid())
  cartaoId        String
  cartao          Cartao            @relation(fields: [cartaoId], references: [id])
  mesReferencia   String
  dataFechamento  DateTime
  dataVencimento  DateTime
  valorTotal      Float             @default(0)
  valorPago       Float             @default(0)
  status          String            @default("ABERTA")
  lancamentos     Lancamento[]
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  PagamentoFatura PagamentoFatura[]

  @@unique([cartaoId, mesReferencia])
}

model PagamentoFatura {
  id          String   @id @default(cuid())
  faturaId    String
  fatura      Fatura   @relation(fields: [faturaId], references: [id])
  valor       Float
  data        DateTime @default(now())
  metodo      String
  observacoes String?
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model LancamentoCompartilhado {
  id                 String                        @id @default(cuid())
  lancamentoId       String                        @unique
  usuarioCriadorId   String
  usuarioAlvoId      String
  status             StatusLancamentoCompartilhado @default(PENDENTE)
  valorCompartilhado Float
  createdAt          DateTime                      @default(now())
  updatedAt          DateTime                      @updatedAt

  lancamento     Lancamento @relation(fields: [lancamentoId], references: [id], onDelete: Cascade)
  usuarioCriador User       @relation("LancamentosCompartilhadosCriados", fields: [usuarioCriadorId], references: [id])
  usuarioAlvo    User       @relation("LancamentosCompartilhadosRecebidos", fields: [usuarioAlvoId], references: [id])

  @@unique([lancamentoId, usuarioAlvoId])
}

enum StatusLancamentoCompartilhado {
  PENDENTE
  ACEITO
  RECUSADO
  CANCELADO
}

model MetaPessoal {
  id               String             @id @default(cuid())
  titulo           String
  descricao        String?
  valorAlvo        Float
  valorAtual       Float              @default(0)
  dataAlvo         DateTime
  categoria        String
  cor              String             @default("#3B82F6")
  icone            String             @default("ðŸŽ¯")
  imagemUrl        String? // ðŸ‘ˆ NOVO CAMPO
  userId           String
  user             User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt
  ConviteMeta      ConviteMeta[]
  ColaboradorMeta  ColaboradorMeta[]
  ContribuicaoMeta ContribuicaoMeta[]

  @@index([userId])
}

model ConviteMeta {
  id             String        @id @default(cuid())
  metaId         String
  emailConvidado String
  token          String        @unique
  status         StatusConvite @default(PENDENTE)
  expiraEm       DateTime
  criadoEm       DateTime      @default(now())
  atualizadoEm   DateTime      @updatedAt

  meta             MetaPessoal @relation(fields: [metaId], references: [id], onDelete: Cascade)
  usuarioCriador   User        @relation(fields: [usuarioCriadorId], references: [id])
  usuarioCriadorId String

  @@unique([metaId, emailConvidado])
  @@index([token])
}

// Modelo para colaboradores da meta
model ColaboradorMeta {
  id        String               @id @default(cuid())
  metaId    String
  userId    String
  criadoEm  DateTime             @default(now())
  permissao PermissaoColaborador @default(LEITURA)

  meta MetaPessoal @relation(fields: [metaId], references: [id], onDelete: Cascade)
  user User        @relation(fields: [userId], references: [id])

  @@unique([metaId, userId])
}

model ContribuicaoMeta {
  id               String   @id @default(cuid())
  metaId           String
  userId           String
  valor            Float
  dataContribuicao DateTime @default(now())
  descricao        String? // DescriÃ§Ã£o opcional da contribuiÃ§Ã£o
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  meta MetaPessoal @relation(fields: [metaId], references: [id], onDelete: Cascade)
  user User        @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([metaId, userId, dataContribuicao])
  @@map("contribuicoes_meta")
}

// Modelo para Limites de Categoria
model LimiteCategoria {
  id            String   @id @default(cuid())
  categoriaId   String
  limiteMensal  Float
  gastoAtual    Float    @default(0)
  mesReferencia String // Formato: "YYYY-MM"
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  categoria Categoria @relation(fields: [categoriaId], references: [id], onDelete: Cascade)

  @@unique([categoriaId, mesReferencia, userId])
  @@index([userId, mesReferencia])
}
